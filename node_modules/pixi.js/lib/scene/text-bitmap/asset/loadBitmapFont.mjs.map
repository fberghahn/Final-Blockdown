{"version":3,"file":"loadBitmapFont.mjs","sources":["../../../../src/scene/text-bitmap/asset/loadBitmapFont.ts"],"sourcesContent":["import { LoaderParserPriority } from '../../../assets/loader/parsers/LoaderParser';\nimport { copySearchParams } from '../../../assets/utils/copySearchParams';\nimport { DOMAdapter } from '../../../environment/adapter';\nimport { ExtensionType } from '../../../extensions/Extensions';\nimport { path } from '../../../utils/path';\nimport { BitmapFont } from '../BitmapFont';\nimport { bitmapFontTextParser } from './bitmapFontTextParser';\nimport { bitmapFontXMLStringParser } from './bitmapFontXMLStringParser';\n\nimport type { Loader } from '../../../assets/loader/Loader';\nimport type { LoaderParser } from '../../../assets/loader/parsers/LoaderParser';\nimport type { ResolvedAsset } from '../../../assets/types';\nimport type { Texture } from '../../../rendering/renderers/shared/texture/Texture';\n\nconst validExtensions = ['.xml', '.fnt'];\n\n/** simple loader plugin for loading in bitmap fonts! */\nexport const bitmapFontCachePlugin = {\n    extension: ExtensionType.CacheParser,\n    test: (asset: BitmapFont) => asset instanceof BitmapFont,\n    getCacheableAssets(keys: string[], asset: BitmapFont)\n    {\n        const out: Record<string, BitmapFont> = {};\n\n        keys.forEach((key) =>\n        {\n            out[key] = asset;\n        });\n\n        out[`${asset.fontFamily}-bitmap`] = asset;\n\n        return out;\n    }\n};\n\nexport const loadBitmapFont = {\n    extension: {\n        type: ExtensionType.LoadParser,\n        priority: LoaderParserPriority.Normal,\n    },\n\n    test(url: string): boolean\n    {\n        return validExtensions.includes(path.extname(url).toLowerCase());\n    },\n\n    async testParse(data: string): Promise<boolean>\n    {\n        return bitmapFontTextParser.test(data) || bitmapFontXMLStringParser.test(data);\n    },\n\n    async parse(asset: string, data: ResolvedAsset, loader: Loader): Promise<BitmapFont>\n    {\n        const bitmapFontData = bitmapFontTextParser.test(asset)\n            ? bitmapFontTextParser.parse(asset)\n            : bitmapFontXMLStringParser.parse(asset);\n\n        const { src } = data;\n        const { pages } = bitmapFontData;\n        const textureUrls = [];\n\n        for (let i = 0; i < pages.length; ++i)\n        {\n            const pageFile = pages[i].file;\n            let imagePath = path.join(path.dirname(src), pageFile);\n\n            imagePath = copySearchParams(imagePath, src);\n\n            textureUrls.push(imagePath);\n        }\n\n        const loadedTextures = await loader.load<Texture>(textureUrls);\n        const textures = textureUrls.map((url) => loadedTextures[url]);\n\n        const bitmapFont = new BitmapFont({\n            data: bitmapFontData,\n            textures\n        }, src);\n\n        return bitmapFont;\n    },\n\n    async load(url: string, _options: ResolvedAsset): Promise<string>\n    {\n        const response = await DOMAdapter.get().fetch(url);\n\n        return await response.text();\n    },\n\n    async unload(bitmapFont: BitmapFont, _resolvedAsset, loader): Promise<void>\n    {\n        await Promise.all(bitmapFont.pages.map((page) => loader.unload(page.texture.source._sourceOrigin)));\n\n        bitmapFont.destroy();\n    }\n} as LoaderParser;\n"],"names":[],"mappings":"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"}